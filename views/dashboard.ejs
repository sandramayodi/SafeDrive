<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Dashboard - SafeDrive </title>
  <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;600&display=swap" rel="stylesheet" />
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" />
  <%
    // Helper function to format timestamps in Nairobi timezone
    function formatNairobiTime(date) {
      if (!date) return 'N/A';
      return new Date(date).toLocaleTimeString('en-KE', { 
        timeZone: 'Africa/Nairobi',
        hour: '2-digit',
        minute: '2-digit',
        second: '2-digit'
      });
    }
    
    function formatNairobiDateTime(date) {
      if (!date) return 'N/A';
      return new Date(date).toLocaleString('en-KE', { 
        timeZone: 'Africa/Nairobi',
        year: 'numeric',
        month: 'short',
        day: 'numeric',
        hour: '2-digit',
        minute: '2-digit',
        second: '2-digit'
      });
    }
  %>
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    body {
      font-family: 'Poppins', sans-serif;
      background: #f0f2f5;
      color: #333;
    }

    /* Header */
    .header {
      background: linear-gradient(135deg, #0a1628 0%, #1a2f4f 100%);
      color: white;
      padding: 1.5rem 2rem;
      display: flex;
      justify-content: space-between;
      align-items: center;
      box-shadow: 0 2px 10px rgba(0,0,0,0.1);
    }

    .header-left {
      display: flex;
      align-items: center;
      gap: 1rem;
    }

    .logo {
      font-size: 1.5rem;
      font-weight: bold;
      color: #00ff88;
    }

    .user-info {
      display: flex;
      align-items: center;
      gap: 1rem;
    }

    .user-info span {
      font-size: 0.95rem;
    }

    .logout-btn {
      background: transparent;
      border: 2px solid #00ff88;
      color: #00ff88;
      padding: 0.5rem 1.5rem;
      border-radius: 25px;
      text-decoration: none;
      transition: all 0.3s;
      font-weight: 500;
    }

    .logout-btn:hover {
      background: #00ff88;
      color: #0a1628;
    }

    /* Main Container */
    .dashboard-container {
      max-width: 1400px;
      margin: 2rem auto;
      padding: 0 2rem;
    }

    /* Status Bar */
    .status-bar {
      background: white;
      border-radius: 15px;
      padding: 2rem;
      margin-bottom: 2rem;
      box-shadow: 0 2px 10px rgba(0,0,0,0.1);
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
      gap: 2rem;
    }

    .status-item {
      text-align: center;
      padding: 1rem;
    }

    .status-item i {
      font-size: 2.5rem;
      margin-bottom: 0.5rem;
    }

    .status-item.safe i { color: #00ff88; }
    .status-item.warning i { color: #ffc107; }
    .status-item.danger i { color: #f44336; }
    .status-item.idle i { color: #2196F3; }
    .status-item.running i { color: #4CAF50; }
    .status-item.locked { 
      background: linear-gradient(135deg, #f44336, #d32f2f);
      color: white;
      animation: pulse 2s infinite;
    }
    .status-item.locked i { 
      color: white;
      animation: shake 0.5s infinite;
    }
    .status-item.locked .status-label,
    .status-item.locked .status-time {
      color: white !important;
    }

    @keyframes pulse {
      0%, 100% { opacity: 1; }
      50% { opacity: 0.85; }
    }

    @keyframes shake {
      0%, 100% { transform: translateX(0); }
      25% { transform: translateX(-5px); }
      75% { transform: translateX(5px); }
    }

    .status-value {
      font-size: 2rem;
      font-weight: bold;
      margin: 0.5rem 0;
    }

    .status-label {
      color: #666;
      font-size: 0.9rem;
      text-transform: uppercase;
      letter-spacing: 1px;
    }

    .status-time {
      color: #999;
      font-size: 0.8rem;
      margin-top: 0.5rem;
    }

    /* Grid Layout */
    .grid-layout {
      display: grid;
      grid-template-columns: 2fr 1fr;
      gap: 2rem;
      margin-bottom: 2rem;
    }

    /* Card Styles */
    .card {
      background: white;
      border-radius: 15px;
      padding: 2rem;
      box-shadow: 0 2px 10px rgba(0,0,0,0.1);
    }

    .card-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 1.5rem;
      padding-bottom: 1rem;
      border-bottom: 2px solid #f0f2f5;
    }

    .card-title {
      font-size: 1.3rem;
      font-weight: 600;
      color: #0a1628;
    }

    .card-icon {
      color: #00ff88;
      font-size: 1.5rem;
    }

    /* Real-time Monitor */
    .monitor-display {
      text-align: center;
      padding: 2rem;
    }

    .bac-reading {
      font-size: 4rem;
      font-weight: bold;
      margin: 1rem 0;
      transition: all 0.3s ease;
    }

    .bac-reading.safe {
      color: #4CAF50;
      text-shadow: 0 0 20px rgba(76, 175, 80, 0.5);
    }

    .bac-reading.warning {
      color: #FFC107;
      text-shadow: 0 0 20px rgba(255, 193, 7, 0.7);
      animation: pulse-text 1.5s ease-in-out infinite;
    }

    .bac-reading.danger {
      color: #f44336;
      text-shadow: 0 0 30px rgba(244, 67, 54, 0.8);
      animation: pulse-text 1s ease-in-out infinite;
    }

    @keyframes pulse-text {
      0%, 100% { transform: scale(1); }
      50% { transform: scale(1.05); }
    }

    .status-badge {
      display: inline-block;
      padding: 0.75rem 2rem;
      border-radius: 30px;
      font-weight: 700;
      text-transform: uppercase;
      font-size: 1.1rem;
      margin-top: 1rem;
      box-shadow: 0 4px 12px rgba(0,0,0,0.2);
      transition: all 0.3s ease;
    }

    .status-badge.safe {
      background: linear-gradient(135deg, #4CAF50, #2e7d32);
      color: white;
      border: 3px solid #2e7d32;
    }

    .status-badge.warning {
      background: linear-gradient(135deg, #FFC107, #FF9800);
      color: #000;
      border: 3px solid #FF6F00;
      animation: pulse-badge 1.5s ease-in-out infinite;
    }

    .status-badge.danger {
      background: linear-gradient(135deg, #f44336, #d32f2f);
      color: white;
      border: 3px solid #b71c1c;
      animation: pulse-badge 1s ease-in-out infinite;
    }

    @keyframes pulse-badge {
      0%, 100% { transform: scale(1); box-shadow: 0 4px 12px rgba(0,0,0,0.2); }
      50% { transform: scale(1.05); box-shadow: 0 6px 20px rgba(0,0,0,0.4); }
    }

    /* Chart Container */
    .chart-container {
      height: 300px;
      margin-top: 1rem;
    }

    /* Alerts */
    .alerts-list {
      max-height: 400px;
      overflow-y: auto;
    }

    .alert-item {
      background: #fff3e0;
      border-left: 4px solid #ff9800;
      padding: 1rem;
      margin-bottom: 1rem;
      border-radius: 5px;
      display: flex;
      justify-content: space-between;
      align-items: start;
    }

    .alert-item.danger {
      background: #ffebee;
      border-left-color: #f44336;
    }

    .alert-content {
      flex: 1;
    }

    .alert-time {
      color: #666;
      font-size: 0.85rem;
      margin-top: 0.5rem;
    }

    .resolve-btn {
      background: #4CAF50;
      color: white;
      border: none;
      padding: 0.4rem 1rem;
      border-radius: 5px;
      cursor: pointer;
      font-size: 0.85rem;
      transition: background 0.3s;
    }

    .resolve-btn:hover {
      background: #388E3C;
    }

    /* Vehicle Status */
    .vehicle-info {
      display: flex;
      flex-direction: column;
      gap: 1rem;
    }

    .vehicle-item {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 1rem;
      background: #f8f9fa;
      border-radius: 10px;
    }

    .vehicle-label {
      color: #666;
      font-weight: 500;
    }

    .vehicle-value {
      font-weight: 600;
      font-size: 1.1rem;
    }

    .vehicle-value.running { color: #4CAF50; }
    .vehicle-value.idle { color: #2196F3; }
    .vehicle-value.locked { color: #f44336; }

    /* Stats Grid */
    .stats-grid {
      display: grid;
      grid-template-columns: repeat(2, 1fr);
      gap: 1rem;
      margin-top: 1rem;
    }

    .stat-box {
      background: #f8f9fa;
      padding: 1.5rem;
      border-radius: 10px;
      text-align: center;
    }

    .stat-value {
      font-size: 2rem;
      font-weight: bold;
      color: #0a1628;
      margin-bottom: 0.5rem;
    }

    .stat-label {
      color: #666;
      font-size: 0.9rem;
    }

    /* GPS Map */
    .map-container {
      height: 300px;
      background: #e0e0e0;
      border-radius: 10px;
      display: flex;
      align-items: center;
      justify-content: center;
      position: relative;
      overflow: hidden;
    }

    .map-placeholder {
      text-align: center;
      color: #666;
    }

    /* Live Indicator */
    .live-indicator {
      display: inline-flex;
      align-items: center;
      gap: 0.5rem;
      color: #f44336;
      font-weight: 600;
      font-size: 0.9rem;
    }

    .live-dot {
      width: 10px;
      height: 10px;
      background: #f44336;
      border-radius: 50%;
      animation: pulse 1.5s infinite;
    }

    @keyframes pulse {
      0%, 100% { opacity: 1; }
      50% { opacity: 0.3; }
    }

    /* No Data Message */
    .no-data {
      text-align: center;
      padding: 2rem;
      color: #999;
    }

    /* Responsive */
    @media (max-width: 1024px) {
      .grid-layout {
        grid-template-columns: 1fr;
      }
    }

    @media (max-width: 768px) {
      .status-bar {
        grid-template-columns: 1fr;
      }

      .header {
        flex-direction: column;
        gap: 1rem;
      }

      .stats-grid {
        grid-template-columns: 1fr;
      }
    }
  </style>
</head>
<body>
  <!-- Header -->
  <div class="header">
    <div class="header-left">
      <div class="logo"><i class="fas fa-car"></i> SafeDrive </div>
    </div>
    <div class="user-info">
      <span><i class="fas fa-user"></i> <%= user.fullName %></span>
      <a href="/logout" class="logout-btn">Logout</a>
    </div>
  </div>

  <!-- Main Dashboard -->
  <div class="dashboard-container">
    
    <!-- Status Bar -->
    <div class="status-bar">
      <div class="status-item <%= (latestReading && (latestReading.status === 'DANGER' || (vehicleStatus && vehicleStatus.vehicle_state === 'LOCKED'))) ? 'danger' : (latestReading && latestReading.status === 'WARNING') ? 'warning' : 'safe' %>" id="topStatusItem">
        <i class="fas fa-wine-bottle"></i>
        <div class="status-value" id="topSensorValue">
          <%= latestReading && latestReading.raw_reading ? latestReading.raw_reading : '0' %>
        </div>
        <div class="status-label">Alcohol Sensor Value</div>
        <% if (latestReading) { %>
          <div class="status-time" id="topSensorTime">
            Updated: <%= formatNairobiTime(latestReading.timestamp) %>
          </div>
        <% } %>
      </div>

      <div class="status-item <%= vehicleStatus ? (vehicleStatus.arduino_status === 'DISCONNECTED' ? 'idle' : vehicleStatus.vehicle_state.toLowerCase()) : 'idle' %>" id="vehicleStatusItem">
        <% if (vehicleStatus && vehicleStatus.arduino_status === 'DISCONNECTED') { %>
          <i class="fas fa-power-off"></i>
          <div class="status-value">‚ö´ OFF</div>
          <div class="status-label">Vehicle Status</div>
          <div class="status-time" style="color: #999;">
            ‚ö†Ô∏è Arduino disconnected - No data
          </div>
        <% } else if (vehicleStatus && vehicleStatus.vehicle_state === 'LOCKED') { %>
          <i class="fas fa-lock"></i>
          <div class="status-value">üîí LOCKED</div>
          <div class="status-label">VEHICLE OFF - ENGINE BLOCKED</div>
          <div class="status-time" style="color: #f44336; font-weight: bold;">
            ‚ö†Ô∏è Cannot start due to high alcohol level
          </div>
        <% } else if (vehicleStatus && vehicleStatus.vehicle_state === 'RUNNING') { %>
          <i class="fas fa-car"></i>
          <div class="status-value">üöó RUNNING</div>
          <div class="status-label">Vehicle Status</div>
          <div class="status-time">
            Engine: <%= vehicleStatus.engine_status || 'ON' %>
          </div>
        <% } else { %>
          <i class="fas fa-pause-circle"></i>
          <div class="status-value">IDLE</div>
          <div class="status-label">Vehicle Status</div>
          <div class="status-time">
            Engine: OFF
          </div>
        <% } %>
      </div>

      <div class="status-item <%= alerts.length > 0 ? 'danger' : 'safe' %>" id="topAlertsItem">
        <i class="fas fa-exclamation-triangle"></i>
        <div class="status-value" id="topAlertsCount"><%= alerts.length %></div>
        <div class="status-label">Active Alerts</div>
      </div>

      <div class="status-item" id="topReadingsItem">
        <i class="fas fa-chart-line"></i>
        <div class="status-value" id="topReadingsCount"><%= stats.total_readings || 0 %></div>
        <div class="status-label">Readings Today</div>
      </div>
    </div>

    <!-- Main Grid Layout -->
    <div class="grid-layout">
      <!-- Left Column -->
      <div>
        <!-- Real-time Monitor -->
        <div class="card">
          <div class="card-header">
            <h2 class="card-title">Real-Time Monitoring</h2>
            <div class="live-indicator">
              <span class="live-dot"></span>
              LIVE
            </div>
          </div>
          
          <div class="monitor-display">
            <div class="bac-reading <%= latestReading ? latestReading.status.toLowerCase() : 'safe' %>" id="bacReading">
              <%= latestReading && latestReading.raw_reading ? latestReading.raw_reading : '0' %>
            </div>
            <div style="margin-top: 1rem; padding: 0.75rem; background: #f5f5f5; border-radius: 8px;">
              <div style="font-size: 0.9rem; color: #666; margin-bottom: 0.5rem;">Sensor Thresholds:</div>
              <div style="display: flex; gap: 1rem; justify-content: center; flex-wrap: wrap;">
                <div style="display: flex; align-items: center; gap: 0.5rem;">
                  <span style="width: 12px; height: 12px; background: #4CAF50; border-radius: 50%; display: inline-block;"></span>
                  <span style="font-size: 0.85rem; color: #666;"><strong>&lt; 180</strong> SAFE</span>
                </div>
                <div style="display: flex; align-items: center; gap: 0.5rem;">
                  <span style="width: 12px; height: 12px; background: #ffc107; border-radius: 50%; display: inline-block;"></span>
                  <span style="font-size: 0.85rem; color: #666;"><strong>180-249</strong> WARNING</span>
                </div>
                <div style="display: flex; align-items: center; gap: 0.5rem;">
                  <span style="width: 12px; height: 12px; background: #f44336; border-radius: 50%; display: inline-block;"></span>
                  <span style="font-size: 0.85rem; color: #666;"><strong>‚â• 250</strong> DANGER</span>
                </div>
              </div>
            </div>
          </div>

          <div class="stats-grid">
            <div class="stat-box">
              <div class="stat-value" id="avgRawValue"><%= stats.avg_raw ? Math.round(stats.avg_raw) : '0' %></div>
              <div class="stat-label">Average Today</div>
            </div>
            <div class="stat-box">
              <div class="stat-value" id="maxRawValue"><%= stats.max_raw ? stats.max_raw : '0' %></div>
              <div class="stat-label">Peak Today</div>
            </div>
            <div class="stat-box">
              <div class="stat-value" id="dangerCountValue"><%= stats.danger_count || 0 %></div>
              <div class="stat-label">Danger Events</div>
            </div>
            <div class="stat-box">
              <% 
                let stateColor = '#4CAF50';
                let stateText = 'SAFE';
                if (latestReading) {
                  if (latestReading.status === 'DANGER' || (vehicleStatus && vehicleStatus.vehicle_state === 'LOCKED')) {
                    stateColor = '#f44336';
                    stateText = 'DANGER';
                  } else if (latestReading.status === 'WARNING') {
                    stateColor = '#ffc107';
                    stateText = 'WARNING';
                  }
                }
              %>
              <div class="stat-value" id="currentStateValue" style="color: <%= stateColor %>">
                <%= stateText %>
              </div>
              <div class="stat-label">Current State</div>
            </div>
          </div>
        </div>

        <!-- History Chart -->
        <div class="card" style="margin-top: 2rem;">
          <div class="card-header">
            <h2 class="card-title">24-Hour History</h2>
            <i class="fas fa-chart-area card-icon"></i>
          </div>
          <div class="chart-container">
            <canvas id="alcoholChart"></canvas>
          </div>
        </div>

        <!-- GPS Location -->
        <div class="card" style="margin-top: 2rem;">
          <div class="card-header">
            <h2 class="card-title">GPS Location</h2>
            <i class="fas fa-map-marker-alt card-icon"></i>
          </div>
          <div class="map-container" id="mapContainer">
            <div class="map-placeholder" id="gpsPlaceholder">
              <i class="fas fa-map-marked-alt" style="font-size: 3rem; color: #999; margin-bottom: 1rem;"></i>
              <p id="gpsCoordinates">
                <% if (gpsLocation) { %>
                  Coordinates: <%= gpsLocation.latitude %>, <%= gpsLocation.longitude %>
                <% } else { %>
                  Fetching location...
                <% } %>
              </p>
              <p style="font-size: 0.9rem; color: #666; margin-top: 0.5rem;" id="gpsTimestamp">
                <% if (gpsLocation) { %>
                  Last Updated: <%= formatNairobiDateTime(gpsLocation.timestamp) %>
                <% } else { %>
                  Waiting for GPS data...
                <% } %>
              </p>
              <button id="viewMapBtn" onclick="openGoogleMapsFromCurrent()" 
                      style="margin-top: 1rem; padding: 0.7rem 1.5rem; background: #00ff88; border: none; border-radius: 5px; cursor: pointer; font-weight: 600;">
                <i class="fas fa-external-link-alt"></i> View on Google Maps
              </button>
              <button id="refreshGPSBtn" onclick="getCurrentLocation()" 
                      style="margin-left: 0.5rem; padding: 0.7rem 1.5rem; background: #2196F3; color: white; border: none; border-radius: 5px; cursor: pointer; font-weight: 600;">
                <i class="fas fa-sync-alt"></i> Refresh Location
              </button>
            </div>
          </div>
        </div>

        <!-- Emergency Contacts -->
        <div class="card" style="margin-top: 2rem;">
          <div class="card-header">
            <h2 class="card-title">Emergency Contacts</h2>
            <i class="fas fa-phone-alt card-icon"></i>
          </div>
          <div class="contacts-container">
            <div id="contactsList" style="margin-bottom: 1rem;">
              <!-- Emergency contacts will be loaded here -->
              <div class="contact-item" style="padding: 0.8rem; background: #f8f9fa; border-radius: 5px; margin-bottom: 0.5rem; display: flex; justify-content: space-between; align-items: center;">
                <div>
                  <i class="fas fa-spinner fa-spin"></i> Loading contacts...
                </div>
              </div>
            </div>
            
            <div class="add-contact-form" style="border-top: 2px solid #e0e0e0; padding-top: 1rem; margin-top: 1rem;">
              <h3 style="font-size: 1rem; margin-bottom: 0.8rem; color: #333;">
                <i class="fas fa-plus-circle"></i> Add New Contact
              </h3>
              <form id="addContactForm" style="display: flex; flex-direction: column; gap: 0.8rem;">
                <div>
                  <input 
                    type="text" 
                    id="contactName" 
                    placeholder="Contact Name (e.g., John Doe)"
                    required
                    style="width: 100%; padding: 0.7rem; border: 1px solid #ddd; border-radius: 5px; font-size: 0.95rem;">
                </div>
                <div>
                  <input 
                    type="tel" 
                    id="contactPhone" 
                    placeholder="Phone Number (e.g., +254712345678)"
                    required
                    pattern="[\+]?[0-9]{10,15}"
                    style="width: 100%; padding: 0.7rem; border: 1px solid #ddd; border-radius: 5px; font-size: 0.95rem;">
                  <small style="color: #666; font-size: 0.85rem;">Format: +254XXXXXXXXX</small>
                </div>
                <div>
                  <select 
                    id="contactRelationship" 
                    required
                    style="width: 100%; padding: 0.7rem; border: 1px solid #ddd; border-radius: 5px; font-size: 0.95rem;">
                    <option value="">Select Relationship</option>
                    <option value="Family">Family</option>
                    <option value="Friend">Friend</option>
                    <option value="Guardian">Guardian</option>
                    <option value="Emergency">Emergency Service</option>
                    <option value="Other">Other</option>
                  </select>
                </div>
                <button 
                  type="submit" 
                  style="padding: 0.8rem; background: #00ff88; border: none; border-radius: 5px; font-weight: 600; cursor: pointer; transition: all 0.3s;">
                  <i class="fas fa-user-plus"></i> Add Contact
                </button>
              </form>
            </div>
          </div>
        </div>
      </div>

      <!-- Right Column -->
      <div>
        <!-- Active Alerts -->
        <div class="card">
          <div class="card-header">
            <h2 class="card-title">Active Alerts</h2>
            <i class="fas fa-bell card-icon"></i>
          </div>
          
          <div class="alerts-list" id="alertsList">
            <% if (alerts.length > 0) { %>
              <% alerts.forEach(alert => { %>
                <div class="alert-item <%= alert.alert_type === 'HIGH_ALCOHOL' ? 'danger' : '' %>">
                  <div class="alert-content">
                    <strong><i class="fas fa-exclamation-circle"></i> <%= alert.alert_type.replace(/_/g, ' ') %></strong>
                    <p><%= alert.message %></p>
                    <% if (alert.alcohol_level) { %>
                      <p>BAC: <%= alert.alcohol_level.toFixed(3) %>%</p>
                    <% } %>
                    <div class="alert-time">
                      <%= formatNairobiDateTime(alert.timestamp) %>
                    </div>
                  </div>
                  <button class="resolve-btn" onclick="resolveAlert(<%= alert.id %>)">
                    <i class="fas fa-check"></i> Resolve
                  </button>
                </div>
              <% }) %>
            <% } else { %>
              <div class="no-data">
                <i class="fas fa-check-circle" style="font-size: 3rem; color: #4CAF50;"></i>
                <p>No active alerts</p>
              </div>
            <% } %>
          </div>
        </div>

        <!-- Vehicle Status -->
        <div class="card" style="margin-top: 2rem;">
          <div class="card-header">
            <h2 class="card-title">Vehicle Control</h2>
            <i class="fas fa-cog card-icon"></i>
          </div>
          
          <div class="vehicle-info">
            <div class="vehicle-item">
              <span class="vehicle-label"><i class="fas fa-car"></i> State</span>
              <span class="vehicle-value <%= vehicleStatus ? vehicleStatus.vehicle_state.toLowerCase() : 'idle' %>" id="vehicleState">
                <%= vehicleStatus ? vehicleStatus.vehicle_state : 'IDLE' %>
              </span>
            </div>
            
            <div class="vehicle-item">
              <span class="vehicle-label"><i class="fas fa-power-off"></i> Engine</span>
              <span class="vehicle-value <%= vehicleStatus && vehicleStatus.engine_status === 'ON' ? 'running' : 'idle' %>" id="engineStatus">
                <%= vehicleStatus ? vehicleStatus.engine_status : 'OFF' %>
              </span>
            </div>
            
            <div class="vehicle-item">
              <span class="vehicle-label"><i class="fas fa-shield-alt"></i> Safety Lock</span>
              <span class="vehicle-value <%= latestReading && latestReading.status === 'DANGER' ? 'locked' : 'running' %>" id="safetyLock">
                <%= latestReading && latestReading.status === 'DANGER' ? 'ENGAGED' : 'DISENGAGED' %>
              </span>
            </div>
            
            <div class="vehicle-item">
              <span class="vehicle-label"><i class="fas fa-tachometer-alt"></i> Raw Sensor</span>
              <span class="vehicle-value running" id="rawSensor">
                <%= latestReading && latestReading.raw_reading ? latestReading.raw_reading : '0' %>
              </span>
            </div>
          </div>
        </div>

        <!-- System Status -->
        <div class="card" style="margin-top: 2rem;">
          <div class="card-header">
            <h2 class="card-title">System Status</h2>
            <i class="fas fa-server card-icon"></i>
          </div>
          
          <div class="vehicle-info">
            <div class="vehicle-item">
              <span class="vehicle-label"><i class="fas fa-microchip"></i> MQ-3 Sensor</span>
              <span class="vehicle-value running">ACTIVE</span>
            </div>
            
            <div class="vehicle-item">
              <span class="vehicle-label"><i class="fas fa-satellite-dish"></i> GPS Module</span>
              <span class="vehicle-value <%= gpsLocation ? 'running' : 'idle' %>">
                <%= gpsLocation ? 'CONNECTED' : 'DISCONNECTED' %>
              </span>
            </div>
            
            <div class="vehicle-item">
              <span class="vehicle-label"><i class="fas fa-signal"></i> GSM Network</span>
              <span class="vehicle-value running">ONLINE</span>
            </div>
            
            <div class="vehicle-item">
              <span class="vehicle-label"><i class="fas fa-clock"></i> Monitoring</span>
              <span class="vehicle-value running">2s Interval</span>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Chart.js -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  
  <script>
    // Nairobi timezone formatting helper functions
    const nairobiTimezone = 'Africa/Nairobi';
    
    function formatNairobiTime(dateString) {
      const date = new Date(dateString);
      return date.toLocaleTimeString('en-KE', { 
        timeZone: nairobiTimezone,
        hour: '2-digit',
        minute: '2-digit',
        second: '2-digit'
      });
    }
    
    function formatNairobiDateTime(dateString) {
      const date = new Date(dateString);
      return date.toLocaleString('en-KE', { 
        timeZone: nairobiTimezone,
        year: 'numeric',
        month: 'short',
        day: 'numeric',
        hour: '2-digit',
        minute: '2-digit',
        second: '2-digit'
      });
    }
    
    // Initialize Chart
    let alcoholChart;
    
    function initChart(data) {
      const ctx = document.getElementById('alcoholChart');
      if (!ctx) return;
      
      const labels = data.map(d => formatNairobiTime(d.timestamp));
      const values = data.map(d => d.raw_reading || 0);
      
      if (alcoholChart) {
        alcoholChart.destroy();
      }
      
      alcoholChart = new Chart(ctx, {
        type: 'line',
        data: {
          labels: labels,
          datasets: [{
            label: 'Sensor Value',
            data: values,
            borderColor: '#00ff88',
            backgroundColor: 'rgba(0, 255, 136, 0.1)',
            tension: 0.4,
            fill: true,
            pointRadius: 3,
            pointHoverRadius: 6
          }, {
            label: 'WARNING (180)',
            data: Array(labels.length).fill(180),
            borderColor: '#ffc107',
            borderDash: [5, 5],
            borderWidth: 2,
            pointRadius: 0,
            fill: false
          }, {
            label: 'DANGER (250)',
            data: Array(labels.length).fill(250),
            borderColor: '#f44336',
            borderDash: [5, 5],
            borderWidth: 2,
            pointRadius: 0,
            fill: false
          }]
        },
        options: {
          responsive: true,
          maintainAspectRatio: false,
          plugins: {
            legend: {
              display: true,
              position: 'top'
            }
          },
          scales: {
            y: {
              beginAtZero: true,
              max: 400,
              ticks: {
                callback: function(value) {
                  return value;
                }
              }
            }
          }
        }
      });
    }
    
    // Load historical data
    function loadHistoricalData() {
      console.log('üìà Loading chart data...', formatNairobiTime(new Date()));
      
      fetch('/api/sensor-history?hours=24&t=' + Date.now())
        .then(res => res.json())
        .then(data => {
          console.log('üìä Chart data points:', data.length);
          if (data.length > 0) {
            initChart(data);
          }
        })
        .catch(err => console.error('Error loading chart data:', err));
    }
    
    // Update alerts list dynamically
    function updateAlertsList(alerts) {
      const alertsList = document.getElementById('alertsList');
      if (!alertsList) return;
      
      console.log('üîî Updating alerts list:', alerts.length, 'alerts');
      
      if (alerts.length === 0) {
        alertsList.innerHTML = `
          <div class="no-data">
            <i class="fas fa-check-circle" style="font-size: 3rem; color: #4CAF50;"></i>
            <p>No active alerts</p>
          </div>
        `;
      } else {
        let alertsHTML = '';
        alerts.forEach(alert => {
          const isDanger = alert.alert_type === 'HIGH_ALCOHOL';
          const alertTime = formatNairobiDateTime(alert.timestamp);
          const alertType = alert.alert_type.replace(/_/g, ' ');
          
          alertsHTML += `
            <div class="alert-item ${isDanger ? 'danger' : ''}">
              <div class="alert-content">
                <strong><i class="fas fa-exclamation-circle"></i> ${alertType}</strong>
                <p>${alert.message}</p>
                ${alert.alcohol_level ? `<p>BAC: ${alert.alcohol_level.toFixed(3)}%</p>` : ''}
                <div class="alert-time">${alertTime}</div>
              </div>
              <button class="resolve-btn" onclick="resolveAlert(${alert.id})">
                <i class="fas fa-check"></i> Resolve
              </button>
            </div>
          `;
        });
        alertsList.innerHTML = alertsHTML;
      }
      
      console.log('‚úì Alerts list updated');
    }
    
    // Real-time updates
    function updateDashboard() {
      console.log('üîÑ Updating dashboard...', formatNairobiTime(new Date()));
      
      // Add cache-busting parameter to prevent browser caching
      fetch('/api/latest-data?t=' + Date.now(), {
        method: 'GET',
        headers: {
          'Cache-Control': 'no-cache, no-store, must-revalidate',
          'Pragma': 'no-cache',
          'Expires': '0'
        }
      })
        .then(res => res.json())
        .then(data => {
          console.log('üì° Received data:', data);
          
          if (data.latest_reading) {
            const reading = typeof data.latest_reading === 'string' 
              ? JSON.parse(data.latest_reading) 
              : data.latest_reading;
            
            console.log('üìä Sensor reading:', reading);
            
            // Update top status bar
            const topStatusItem = document.getElementById('topStatusItem');
            const topSensorValue = document.getElementById('topSensorValue');
            const topSensorTime = document.getElementById('topSensorTime');
            
            const bacElement = document.getElementById('bacReading');
            const statusElement = document.getElementById('statusBadge');
            
            // Update sensor reading and status
            if (bacElement) {
              bacElement.textContent = reading.raw_reading || 'N/A';
              bacElement.className = 'bac-reading ' + reading.status.toLowerCase();
              console.log('‚úì Updated bacReading:', reading.raw_reading);
            }
            
            if (statusElement) {
              statusElement.textContent = reading.status;
              statusElement.className = 'status-badge ' + reading.status.toLowerCase();
              console.log('‚úì Updated status:', reading.status);
            }
            
            // Update vehicle control elements
            if (data.vehicle_status) {
              const vehicleStatus = typeof data.vehicle_status === 'string'
                ? JSON.parse(data.vehicle_status)
                : data.vehicle_status;
              
              console.log('üöó Vehicle status:', vehicleStatus);
              
              // Update current state stat box (after getting vehicle status)
              const currentStateValue = document.getElementById('currentStateValue');
              console.log('üéØ currentStateValue element:', currentStateValue);
              
              if (currentStateValue) {
                let stateColor = '#4CAF50';
                let stateText = 'SAFE';
                
                console.log('üìç Reading status:', reading.status, ', Vehicle state:', vehicleStatus.vehicle_state);
                
                if (reading.status === 'DANGER' || vehicleStatus.vehicle_state === 'LOCKED') {
                  stateColor = '#f44336';
                  stateText = 'DANGER';
                } else if (reading.status === 'WARNING') {
                  stateColor = '#ffc107';
                  stateText = 'WARNING';
                }
                
                currentStateValue.textContent = stateText;
                currentStateValue.style.color = stateColor;
                console.log('‚úì Updated currentState:', stateText, 'with color:', stateColor);
              } else {
                console.error('‚ùå currentStateValue element not found!');
              }
              
              // Update top status bar with real-time data
              if (topStatusItem && topSensorValue) {
                topSensorValue.textContent = reading.raw_reading || '0';
                
                // Determine status class based on reading and vehicle state
                let statusClass = 'safe';
                if (reading.status === 'DANGER' || vehicleStatus.vehicle_state === 'LOCKED') {
                  statusClass = 'danger';
                } else if (reading.status === 'WARNING') {
                  statusClass = 'warning';
                }
                
                topStatusItem.className = 'status-item ' + statusClass;
                console.log('‚úì Updated top status bar:', reading.raw_reading, 'with status:', statusClass);
              }
              
              if (topSensorTime) {
                topSensorTime.textContent = 'Updated: ' + formatNairobiTime(reading.timestamp);
              }
              
              // Update top vehicle status item based on Arduino connection
              const vehicleStatusItem = document.getElementById('vehicleStatusItem');
              if (vehicleStatusItem) {
                let statusClass = 'idle';
                let statusIcon = '<i class="fas fa-pause-circle"></i>';
                let statusValue = 'IDLE';
                let statusLabel = 'Vehicle Status';
                let statusTime = '';
                
                if (vehicleStatus.arduino_status === 'DISCONNECTED') {
                  statusIcon = '<i class="fas fa-power-off"></i>';
                  statusValue = '‚ö´ OFF';
                  statusLabel = 'Vehicle Status';
                  statusTime = '<div class="status-time" style="color: #999;">‚ö†Ô∏è Arduino disconnected - No data</div>';
                } else if (vehicleStatus.vehicle_state === 'LOCKED') {
                  statusClass = 'locked';
                  statusIcon = '<i class="fas fa-lock"></i>';
                  statusValue = 'üîí LOCKED';
                  statusLabel = 'VEHICLE OFF - ENGINE BLOCKED';
                  statusTime = '<div class="status-time" style="color: #f44336; font-weight: bold;">‚ö†Ô∏è Cannot start due to high alcohol level</div>';
                } else if (vehicleStatus.vehicle_state === 'RUNNING') {
                  statusClass = 'running';
                  statusIcon = '<i class="fas fa-car"></i>';
                  statusValue = 'üöó RUNNING';
                  statusLabel = 'Vehicle Status';
                  statusTime = '<div class="status-time">Engine: ' + (vehicleStatus.engine_status || 'ON') + '</div>';
                }
                
                vehicleStatusItem.className = 'status-item ' + statusClass;
                vehicleStatusItem.innerHTML = statusIcon + 
                  '<div class="status-value">' + statusValue + '</div>' +
                  '<div class="status-label">' + statusLabel + '</div>' + statusTime;
                  
                console.log('‚úì Updated vehicle status item:', statusValue, 'arduino:', vehicleStatus.arduino_status);
              }
              
              const vehicleState = document.getElementById('vehicleState');
              const engineStatus = document.getElementById('engineStatus');
              const safetyLock = document.getElementById('safetyLock');
              const rawSensor = document.getElementById('rawSensor');
              
              if (vehicleState) {
                vehicleState.textContent = vehicleStatus.vehicle_state || 'IDLE';
                vehicleState.className = 'vehicle-value ' + (vehicleStatus.vehicle_state || 'idle').toLowerCase();
                console.log('‚úì Updated vehicleState:', vehicleStatus.vehicle_state);
              }
              
              if (engineStatus) {
                engineStatus.textContent = vehicleStatus.engine_status || 'OFF';
                engineStatus.className = 'vehicle-value ' + (vehicleStatus.engine_status === 'ON' ? 'running' : 'idle');
                console.log('‚úì Updated engineStatus:', vehicleStatus.engine_status);
              }
              
              if (safetyLock) {
                const isEngaged = reading.status === 'DANGER' || vehicleStatus.vehicle_state === 'LOCKED';
                safetyLock.textContent = isEngaged ? 'ENGAGED' : 'DISENGAGED';
                safetyLock.className = 'vehicle-value ' + (isEngaged ? 'locked' : 'running');
                console.log('‚úì Updated safetyLock:', isEngaged ? 'ENGAGED' : 'DISENGAGED', '(status:', reading.status, ', vehicle:', vehicleStatus.vehicle_state + ')');
              }
              
              if (rawSensor) {
                rawSensor.textContent = reading.raw_reading || '0';
                console.log('‚úì Updated rawSensor:', reading.raw_reading);
              }
            }
          } else {
            console.warn('‚ö†Ô∏è No latest_reading in response');
          }
          
          // Update alerts count in top status bar
          if (data.alerts) {
            const alerts = typeof data.alerts === 'string' ? JSON.parse(data.alerts) : data.alerts;
            const topAlertsItem = document.getElementById('topAlertsItem');
            const topAlertsCount = document.getElementById('topAlertsCount');
            
            if (topAlertsCount) {
              topAlertsCount.textContent = alerts.length;
              console.log('‚úì Updated alerts count:', alerts.length);
            }
            
            if (topAlertsItem) {
              topAlertsItem.className = 'status-item ' + (alerts.length > 0 ? 'danger' : 'safe');
            }
            
            // Update alerts list section
            updateAlertsList(alerts);
          }
          
          // Update stats in top status bar and cards
          if (data.stats) {
            const stats = typeof data.stats === 'string' ? JSON.parse(data.stats) : data.stats;
            
            const topReadingsCount = document.getElementById('topReadingsCount');
            const avgRawValue = document.getElementById('avgRawValue');
            const maxRawValue = document.getElementById('maxRawValue');
            const dangerCountValue = document.getElementById('dangerCountValue');
            
            if (topReadingsCount) {
              topReadingsCount.textContent = stats.total_readings || 0;
              console.log('‚úì Updated readings count:', stats.total_readings);
            }
            
            if (avgRawValue) {
              avgRawValue.textContent = stats.avg_raw ? Math.round(stats.avg_raw) : '0';
            }
            
            if (maxRawValue) {
              maxRawValue.textContent = stats.max_raw || '0';
            }
            
            if (dangerCountValue) {
              dangerCountValue.textContent = stats.danger_count || 0;
            }
          }
        })
        .catch(err => console.error('‚ùå Error updating dashboard:', err));
    }
    
    // GPS Location variables
    let currentLatitude = null;
    let currentLongitude = null;
    let watchId = null;              // For continuous GPS tracking
    let bestAccuracy = Infinity;     // Track best accuracy achieved
    
    // Get current location from browser with enhanced accuracy
    function getCurrentLocation() {
      console.log('üìç Requesting GPS location...');
      
      if (!navigator.geolocation) {
        console.error('‚ùå Geolocation is not supported by this browser');
        alert('Your browser does not support geolocation');
        return;
      }
      
      const refreshBtn = document.getElementById('refreshGPSBtn');
      if (refreshBtn) {
        refreshBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Getting Location...';
        refreshBtn.disabled = true;
      }
      
      navigator.geolocation.getCurrentPosition(
        (position) => {
          currentLatitude = position.coords.latitude;
          currentLongitude = position.coords.longitude;
          const accuracy = position.coords.accuracy;
          
          console.log('‚úÖ Location obtained:');
          console.log('   Latitude:', currentLatitude);
          console.log('   Longitude:', currentLongitude);
          console.log('   Accuracy:', accuracy, 'meters');
          console.log('   Timestamp:', new Date(position.timestamp).toLocaleString());
          
          // Update display
          updateGPSDisplay(currentLatitude, currentLongitude, accuracy);
          
          // Send to server
          sendLocationToServer(currentLatitude, currentLongitude);
          
          if (refreshBtn) {
            refreshBtn.innerHTML = '<i class="fas fa-sync-alt"></i> Refresh Location';
            refreshBtn.disabled = false;
          }
        },
        (error) => {
          console.error('‚ùå Error getting location:', error.message);
          
          let errorMsg = 'Unable to get location';
          switch(error.code) {
            case error.PERMISSION_DENIED:
              errorMsg = 'Location permission denied. Please enable location access in your browser settings.';
              break;
            case error.POSITION_UNAVAILABLE:
              errorMsg = 'Location information unavailable.';
              break;
            case error.TIMEOUT:
              errorMsg = 'Location request timed out.';
              break;
          }
          
          alert(errorMsg);
          
          if (refreshBtn) {
            refreshBtn.innerHTML = '<i class="fas fa-sync-alt"></i> Refresh Location';
            refreshBtn.disabled = false;
          }
        },
        {
          enableHighAccuracy: true,    // Use GPS instead of WiFi/IP
          timeout: 30000,               // Increased to 30 seconds for better GPS lock
          maximumAge: 0                 // Don't use cached position
        }
      );
    }
    
    // Update GPS display
    function updateGPSDisplay(lat, lng, accuracy = null) {
      const coordsElement = document.getElementById('gpsCoordinates');
      const timestampElement = document.getElementById('gpsTimestamp');
      
      if (coordsElement) {
        let html = `<strong>Coordinates:</strong> ${lat.toFixed(6)}, ${lng.toFixed(6)}<br>`;
        
        if (accuracy) {
          // Color-coded accuracy indicator
          let accuracyColor = '#28a745'; // Green
          let accuracyLevel = 'Excellent';
          
          if (accuracy > 100) {
            accuracyColor = '#dc3545'; // Red
            accuracyLevel = 'Poor (IP-based)';
          } else if (accuracy > 50) {
            accuracyColor = '#ffc107'; // Yellow
            accuracyLevel = 'Moderate';
          } else if (accuracy > 20) {
            accuracyColor = '#17a2b8'; // Blue
            accuracyLevel = 'Good';
          }
          
          html += `<span style="font-size: 0.85rem; color: ${accuracyColor}; font-weight: bold;">
                     <i class="fas fa-map-marker-alt"></i> ${accuracyLevel}: ¬±${Math.round(accuracy)}m
                   </span><br>`;
        }
        
        html += `<span style="font-size: 0.85rem; color: #666;" id="addressText">Getting address...</span>`;
        coordsElement.innerHTML = html;
      }
      
      if (timestampElement) {
        timestampElement.textContent = 'Last Updated: ' + formatNairobiDateTime(new Date());
      }
      
      // Get address from coordinates using reverse geocoding
      getAddressFromCoordinates(lat, lng);
      
      console.log('‚úì GPS display updated');
    }
    
    // Get address from coordinates using reverse geocoding
    function getAddressFromCoordinates(lat, lng) {
      const url = `https://nominatim.openstreetmap.org/reverse?format=json&lat=${lat}&lon=${lng}&zoom=18&addressdetails=1`;
      
      fetch(url)
        .then(res => res.json())
        .then(data => {
          console.log('üìç Location details:', data);
          
          const addressElement = document.getElementById('addressText');
          if (addressElement && data.display_name) {
            addressElement.innerHTML = `<strong>üìç Address:</strong> ${data.display_name}`;
            addressElement.style.color = '#333';
          }
          
          // Also send address to server
          if (data.display_name) {
            updateLocationWithAddress(lat, lng, data.display_name);
          }
        })
        .catch(err => {
          console.error('‚ùå Error getting address:', err);
          const addressElement = document.getElementById('addressText');
          if (addressElement) {
            addressElement.textContent = 'Address lookup failed';
          }
        });
    }
    
    // Send location to server
    function sendLocationToServer(lat, lng, address = null) {
      console.log('üì§ Sending GPS to server:', lat, lng, address);
      
      const payload = {
        device_id: 'web_browser',
        latitude: lat,
        longitude: lng,
        user_id: <%= user.id %>
      };
      
      if (address) {
        payload.address = address;
      }
      
      fetch('/api/gps-data', {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json'
        },
        body: JSON.stringify(payload)
      })
        .then(res => res.json())
        .then(data => {
          console.log('‚úÖ GPS data sent successfully:', data);
        })
        .catch(err => {
          console.error('‚ùå Error sending GPS data:', err);
        });
    }
    
    // Update location with address
    function updateLocationWithAddress(lat, lng, address) {
      sendLocationToServer(lat, lng, address);
    }
    
    // Open Google Maps with current location
    function openGoogleMapsFromCurrent() {
      if (currentLatitude && currentLongitude) {
        openGoogleMaps(currentLatitude, currentLongitude);
      } else {
        alert('Getting your location first...');
        getCurrentLocation();
      }
    }
    
    // Resolve alert
    function resolveAlert(alertId) {
      if (!confirm('Mark this alert as resolved?')) return;
      
      fetch(`/api/resolve-alert/${alertId}`, {
        method: 'POST'
      })
        .then(res => res.json())
        .then(() => {
          // Refresh dashboard instead of full page reload
          updateDashboard();
        })
        .catch(err => console.error('Error resolving alert:', err));
    }
    
    // Open Google Maps
    function openGoogleMaps(lat, lng) {
      window.open(`https://www.google.com/maps?q=${lat},${lng}`, '_blank');
    }
    
    // Start continuous GPS tracking for better accuracy
    function startContinuousTracking() {
      if (!navigator.geolocation) return;
      
      // Stop previous tracking if exists
      if (watchId !== null) {
        navigator.geolocation.clearWatch(watchId);
      }
      
      console.log('üîÑ Starting continuous GPS tracking for improved accuracy...');
      
      watchId = navigator.geolocation.watchPosition(
        (position) => {
          const lat = position.coords.latitude;
          const lng = position.coords.longitude;
          const accuracy = position.coords.accuracy;
          const altitude = position.coords.altitude;
          const speed = position.coords.speed;
          
          // Log all available GPS data
          console.log('üì° GPS Update:');
          console.log('   Lat/Lng:', lat.toFixed(6), ',', lng.toFixed(6));
          console.log('   Accuracy:', Math.round(accuracy), 'meters');
          if (altitude !== null) console.log('   Altitude:', altitude.toFixed(1), 'meters');
          if (speed !== null) console.log('   Speed:', speed.toFixed(1), 'm/s');
          
          // Only update if accuracy is better than 100 meters
          // This filters out low-quality IP-based locations
          if (accuracy <= 100) {
            // If this is more accurate than previous, update
            if (accuracy < bestAccuracy) {
              bestAccuracy = accuracy;
              currentLatitude = lat;
              currentLongitude = lng;
              
              console.log('‚ú® Better accuracy achieved! Updating location...');
              updateGPSDisplay(lat, lng, accuracy);
              sendLocationToServer(lat, lng);
            }
          } else {
            console.log('‚ö†Ô∏è Low accuracy (' + Math.round(accuracy) + 'm) - waiting for better signal...');
          }
        },
        (error) => {
          console.error('‚ùå GPS tracking error:', error.message);
        },
        {
          enableHighAccuracy: true,    // Use GPS hardware
          timeout: 30000,               // 30 second timeout
          maximumAge: 0                 // Always get fresh position
        }
      );
    }
    
    // Stop continuous tracking
    function stopContinuousTracking() {
      if (watchId !== null) {
        navigator.geolocation.clearWatch(watchId);
        watchId = null;
        console.log('üõë Stopped continuous GPS tracking');
      }
    }
    
    // Emergency Contacts Management
    async function loadEmergencyContacts() {
      try {
        const response = await fetch('/api/emergency-contacts');
        const data = await response.json();
        
        const contactsList = document.getElementById('contactsList');
        
        if (!data.contacts || data.contacts.length === 0) {
          contactsList.innerHTML = `
            <div class="contact-item" style="padding: 1rem; text-align: center; color: #999; background: #f8f9fa; border-radius: 5px;">
              <i class="fas fa-user-friends" style="font-size: 2rem; margin-bottom: 0.5rem;"></i>
              <p>No emergency contacts added yet</p>
              <p style="font-size: 0.85rem;">Add contacts below to receive SMS alerts</p>
            </div>
          `;
          return;
        }
        
        contactsList.innerHTML = data.contacts.map(contact => `
          <div class="contact-item" style="padding: 0.8rem; background: #f8f9fa; border-radius: 5px; margin-bottom: 0.5rem; display: flex; justify-content: space-between; align-items: center;">
            <div style="flex: 1;">
              <div style="font-weight: 600; color: #333; margin-bottom: 0.2rem;">
                <i class="fas fa-user"></i> ${contact.name}
              </div>
              <div style="font-size: 0.85rem; color: #666;">
                <i class="fas fa-phone"></i> ${contact.phone_number}
              </div>
              <div style="font-size: 0.8rem; color: #888; margin-top: 0.2rem;">
                <i class="fas fa-tag"></i> ${contact.relationship}
              </div>
            </div>
            <button 
              onclick="deleteContact(${contact.id})" 
              style="padding: 0.5rem 1rem; background: #dc3545; color: white; border: none; border-radius: 5px; cursor: pointer; transition: all 0.3s;">
              <i class="fas fa-trash-alt"></i>
            </button>
          </div>
        `).join('');
        
      } catch (error) {
        console.error('Error loading contacts:', error);
        document.getElementById('contactsList').innerHTML = `
          <div class="contact-item" style="padding: 1rem; text-align: center; color: #dc3545; background: #fff3cd; border-radius: 5px;">
            <i class="fas fa-exclamation-triangle"></i> Failed to load contacts
          </div>
        `;
      }
    }
    
    // Add new emergency contact
    document.getElementById('addContactForm')?.addEventListener('submit', async (e) => {
      e.preventDefault();
      
      const name = document.getElementById('contactName').value.trim();
      const phone = document.getElementById('contactPhone').value.trim();
      const relationship = document.getElementById('contactRelationship').value;
      
      if (!name || !phone || !relationship) {
        alert('Please fill all fields');
        return;
      }
      
      try {
        const response = await fetch('/api/emergency-contacts', {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json'
          },
          body: JSON.stringify({
            name: name,
            phone_number: phone,
            relationship: relationship
          })
        });
        
        const data = await response.json();
        
        if (data.success) {
          // Clear form
          document.getElementById('contactName').value = '';
          document.getElementById('contactPhone').value = '';
          document.getElementById('contactRelationship').value = '';
          
          // Reload contacts list
          loadEmergencyContacts();
          
          alert('‚úÖ Contact added successfully!');
        } else {
          alert('‚ùå Failed to add contact: ' + (data.error || 'Unknown error'));
        }
      } catch (error) {
        console.error('Error adding contact:', error);
        alert('‚ùå Error adding contact. Please try again.');
      }
    });
    
    // Delete emergency contact
    async function deleteContact(contactId) {
      if (!confirm('Are you sure you want to delete this contact?')) {
        return;
      }
      
      try {
        const response = await fetch(`/api/emergency-contacts/${contactId}`, {
          method: 'DELETE'
        });
        
        const data = await response.json();
        
        if (data.success) {
          loadEmergencyContacts();
          alert('‚úÖ Contact deleted successfully!');
        } else {
          alert('‚ùå Failed to delete contact');
        }
      } catch (error) {
        console.error('Error deleting contact:', error);
        alert('‚ùå Error deleting contact. Please try again.');
      }
    }
    
    // Initialize on page load
    document.addEventListener('DOMContentLoaded', () => {
      console.log('‚úÖ Dashboard loaded, starting real-time updates...');
      
      // Load emergency contacts
      loadEmergencyContacts();
      
      // Get initial GPS location
      getCurrentLocation();
      
      // Start continuous GPS tracking for better accuracy
      startContinuousTracking();
      
      // Load initial chart data
      loadHistoricalData();
      
      // Call immediately on load
      updateDashboard();
      
      // Update dashboard data every 3 seconds for real-time monitoring
      setInterval(updateDashboard, 3000);
      
      // Reload chart every 10 seconds to show latest data
      setInterval(loadHistoricalData, 10000);
    });
  </script>
</body>
</html>
